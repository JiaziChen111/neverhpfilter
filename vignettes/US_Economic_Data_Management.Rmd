---
title: "U.S. Economic Data and the HL-Filter"
author: "Justin M. Shea"
date: "June 17th, 2017"
output:
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
vignette: >
  %\VignetteIndexEntry{Economic Data and HL-Filter}  
  %\VignetteEngine{knitr::rmarkdown}  
  %\VignetteEncoding{UTF-8}
---

```{r, setup, include=FALSE}
library(tufte)
# invalidate cache when the tufte version changes
knitr::opts_chunk$set(tidy = FALSE, cache.extra = packageVersion('tufte'))
options(htmltools.dir.version = FALSE)

#file_functions <- path.expand("~/Roosevelt/Macropaper/R/Great_Moderation_function_Script.R")
#source(file_functions)
```

This vignette documents reproducible steps of acquiring and pre-processing U.S. Economic data. The process indicates how to avoid and test for common errors arising in data management. In addition,  a few models are run and displayed to illustrate the validity and application of the data. 


# Data Series and Sources

We collected all data through the economic research website of the Federal Reserve Bank of St. Louis, commonly known as "FRED". In addition, FRED links to other credible data sources as well, including the U.S. Department of Commerce Bureau of Economic Analysis. Below, tables indicate which economic data are obtained and processed.

\newpage

```{r echo = FALSE, message = FALSE, warning = FALSE, cache=TRUE}
########################################################### 
###  The GREAT MODERATION or ACCUMULATION OF DEBT paper ###
########################################################### 
library(xts)
library(micEconIndex)
library(knitr)

# Real series are available for the main indexes to test methodology against #
Real_Gross_Domestic_Product <- "https://research.stlouisfed.org/fred2/data/GDPC96.txt"

### Download GDP directly from FRED into xts time series object 
rGDP <- as.xts(read.zoo(Real_Gross_Domestic_Product, skip = 12, index.column = 1, 
                            header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))

### Test Fisher Tranformation Method using GDP 
# Define file paths
GDP_nom <- "https://fred.stlouisfed.org/data/GDP.txt"
GDP_Quantity_Index <- "https://fred.stlouisfed.org/data/A191RA3Q086SBEA.txt"
GDP_Price_Index <- "https://fred.stlouisfed.org/data/A191RG3Q086SBEA.txt"

# Get data
GDP          <- as.xts(read.zoo(GDP_nom, skip = 19, index.column = 1, header = TRUE, 
                       format = "%Y-%m-%d", FUN = as.yearqtr))
GDP_Quantity <- as.xts(read.zoo(GDP_Quantity_Index, skip = 14, index.column = 1, 
                        header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
GDP_Price    <- as.xts(read.zoo(GDP_Price_Index, skip = 14, index.column = 1, 
                             header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))

## Merge Price and Quantity objects
QP_GDP <- merge(GDP_Price, GDP_Quantity)

## Extract data frame for using coredata function
f_GDP  <- data.frame(coredata(QP_GDP))
colnames(f_GDP) <- c("PRICE","QUANTITY")

## Now, call priceIndex() and set the method to "Fisher" ##
library(micEconIndex)
Fisher_GDP <- priceIndex("PRICE", "QUANTITY", base=249, data=f_GDP, method="Fisher")

# Calculate Real GDP
Real_GDP <- merge(GDP/Fisher_GDP)

# Compare 
gdp_test <- merge(Real_GDP, rGDP)
gdp_test$diff <- gdp_test$Real_GDP - gdp_test$rGDP

# View(gdp_test)

# regression test for accuracy
gdp_reg <- lm(Real_GDP ~ rGDP, gdp_test)
#summary(gdp_reg)

# An adj. R^2 of 1 proves its a nearly indentical transformation.

# So lets make a fucntion to use for other components
Fisher <- function(w,x,y,z) {
        ## x = price index, y = quantity index 
        ## z = base period of objects. ie 249 for Q1 2009.
        ## w = component series
        require(micEconIndex)
        require(xts)
        ## Merge Price and Quantity XTS objects
        QP <- merge(x, y)
        ## Extract data frame for using priceIndex function
        f_QP <- data.frame(coredata(QP))
        colnames(f_QP) <- c("PRICE","QUANTITY")
        ## Now, call priceIndex() and set the method to "Fisher". ##
        
        Fisher_QP <- priceIndex("PRICE", "QUANTITY", base=z, data=f_QP, method="Fisher")
        # Calculate Real GDP
        rQP <- merge(w/Fisher_QP)
        return(rQP)
}

#################################################################################
## Original, Quantity, and Price indexes for Transformations via Fisher index ##
#################################################################################

### GDP Components, main catagories ###
Fixed_Private_Investment <- "https://fred.stlouisfed.org/data/FPI.txt"
      FPI_Quantity_Index <- "https://fred.stlouisfed.org/data/A007RA3Q086SBEA.txt"
         FPI_Price_Index <- "https://fred.stlouisfed.org/data/B007RG3Q086SBEA.txt"
#------------------------------#
Personal_Consumption_Expenditures <- "https://fred.stlouisfed.org/data/PCEC.txt"
               PCE_Quantity_Index <- "https://fred.stlouisfed.org/data/DPCERA3Q086SBEA.txt"
                  PCE_Price_Index <- "https://fred.stlouisfed.org/data/PCECTPI.txt"

                  
### PCE component Original ###
   PCE_Durable_Goods <- "https://research.stlouisfed.org/fred2/data/PCDG.txt"
PCE_Nondurable_Goods <- "https://research.stlouisfed.org/fred2/data/PCND.txt"
        PCE_Services <- "https://research.stlouisfed.org/fred2/data/PCESV.txt"

## PCE Quantity & Price Indexes ##
Durable_Goods_Quanity_Index <- "https://research.stlouisfed.org/fred2/data/DDURRA3Q086SBEA.txt"
  Durable_Goods_Price_Index <- "https://research.stlouisfed.org/fred2/data/DDURRG3Q086SBEA.txt"
#------------------------------#
Nondurable_Goods_Quantity_Index <- "https://research.stlouisfed.org/fred2/data/DNDGRA3Q086SBEA.txt"
   Nondurable_Goods_Price_Index <- "https://research.stlouisfed.org/fred2/data/DNDGRG3Q086SBEA.txt"
#------------------------------#
Services_Quantity_Index <- "https://research.stlouisfed.org/fred2/data/DSERRA3Q086SBEA.txt"
   Services_Price_Index <- "https://research.stlouisfed.org/fred2/data/DSERRG3Q086SBEA.txt"

   
### Fixed Private Investment component Original Series ###
Residential_Fixed_Investment <- "https://research.stlouisfed.org/fred2/data/PRFI.txt"
Nonresidential_Fixed_Investment <- "https://research.stlouisfed.org/fred2/data/PNFI.txt"

## FPI Quantity & Price Indexes ##
Residential_Quantity_Index <- "https://research.stlouisfed.org/fred2/data/A011RA3Q086SBEA.txt"
   Residential_Price_Index <- "https://research.stlouisfed.org/fred2/data/B011RG3Q086SBEA.txt" 
#-------------------------------#
Nonresidential_Quantity_Index <- "https://research.stlouisfed.org/fred2/data/A008RA3Q086SBEA.txt"        
   Nonresidential_Price_Index <- "https://research.stlouisfed.org/fred2/data/B008RG3Q086SBEA.txt"
 

### Exports/Imports Original Series ###
Exports_Goods_Services <- "https://fred.stlouisfed.org/data/EXPGS.txt"
Imports_Goods_Services <- "https://fred.stlouisfed.org/data/IMPGS.txt"

## NET Export Quantity & Price Indexes ###
Exports_Quantity_Index <- "https://fred.stlouisfed.org/data/B020RA3Q086SBEA.txt"
        Exports_Price_Index <- "https://fred.stlouisfed.org/data/B020RG3Q086SBEA.txt"
#-------------------------------------#
Imports_Quantity_Index <- "https://fred.stlouisfed.org/data/B021RA3Q086SBEA.txt"
        Imports_Price_Index <- "https://fred.stlouisfed.org/data/B021RG3Q086SBEA.txt"

        
### Government Consumption Expenditures ###
Government_Expenditures <- "https://fred.stlouisfed.org/data/GCE.txt"
                        Federal_GCE <- "https://fred.stlouisfed.org/data/FGCE.txt"
                    State_Local_GCE <- "https://fred.stlouisfed.org/data/SLCE.txt"
                    
## GCE Quantity & Price INdexes
GCE_Quantity_Index <- "https://fred.stlouisfed.org/data/B822RA3Q086SBEA.txt"
        GCE_Price_Index <- "https://fred.stlouisfed.org/data/B822RG3Q086SBEA.txt"
#-------------------------------------#
Federal_Quantity_Index <- "https://fred.stlouisfed.org/data/B823RA3Q086SBEA.txt"
        Federal_Price_Index <- "https://fred.stlouisfed.org/data/B823RG3Q086SBEA.txt"
#-------------------------------------#
State_Local_Quantity_Index <- "https://fred.stlouisfed.org/data/B829RA3Q086SBEA.txt"
        State_Local_Price_Index <- "https://fred.stlouisfed.org/data/B829RG3Q086SBEA.txt"

        
GDP_Table <- t(data.frame(GDP_nom, GDP_Quantity_Index, GDP_Price_Index,
                          Fixed_Private_Investment, FPI_Quantity_Index, FPI_Price_Index, 
                          Personal_Consumption_Expenditures, PCE_Quantity_Index, PCE_Price_Index, 
                          PCE_Durable_Goods, PCE_Nondurable_Goods, PCE_Services, Durable_Goods_Quanity_Index, 
                          Durable_Goods_Price_Index, Nondurable_Goods_Quantity_Index, 
                          Nondurable_Goods_Price_Index, Services_Quantity_Index, Services_Price_Index, 
                          Residential_Fixed_Investment, Nonresidential_Fixed_Investment, 
                          Residential_Quantity_Index, Residential_Price_Index, 
                          Nonresidential_Quantity_Index, Nonresidential_Price_Index,
                          Exports_Goods_Services, Imports_Goods_Services, Exports_Quantity_Index, 
                          Exports_Price_Index, Imports_Quantity_Index, Imports_Price_Index, 
                          Government_Expenditures, Federal_GCE, State_Local_GCE, 
                          GCE_Quantity_Index, GCE_Price_Index, Federal_Quantity_Index, 
                          Federal_Price_Index, State_Local_Quantity_Index, State_Local_Price_Index))
 
colnames(GDP_Table) <- "GDP & Components."              
```


```{r echo = FALSE, message = FALSE, warning = FALSE, cache=TRUE}
### Employment Rate ###
Total_Nonfarm_Payrolls   <- "https://fred.stlouisfed.org/data/PAYEMS.txt"
Civilian_Employment_Rate <- "https://fred.stlouisfed.org/data/CE16OV.txt"

### Download Employment Rate MONTHLY series###
Employment_Establishment <- as.xts(read.zoo(Total_Nonfarm_Payrolls , sep = "", skip = 42, index.column = 1, header = TRUE, format = "%Y-%m-%d", FUN = as.yearmon))
Employment_Household     <- as.xts(read.zoo(Civilian_Employment_Rate, sep = "", skip = 19, index.column = 1, header = TRUE, format = "%Y-%m-%d", FUN = as.yearmon))

### Productivity Rate ##
Real_Output_Per_Person   <- "https://fred.stlouisfed.org/data/PRS85006163.txt"
Real_Output_Per_Hour     <- "https://fred.stlouisfed.org/data/OPHNFB.txt"

Productivity_Person  <- as.xts(read.zoo(Real_Output_Per_Person, sep = "", skip = 10,    
                        index.column = 1, header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Productivity_Hour    <- as.xts(read.zoo(Real_Output_Per_Hour, sep = "", skip = 15, 
                        index.column = 1, header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))

Employment_Table <- t(data.frame(Total_Nonfarm_Payrolls, Civilian_Employment_Rate, Real_Output_Per_Person,Real_Output_Per_Hour))
colnames(Employment_Table) <- "Employment and Productivity"

kable(Employment_Table, align = "l", caption = "Employment & Productivity data sources")
```

```{r echo = FALSE, message = FALSE, warning = FALSE, cache=TRUE}
### Inflation Data ###
Producer_Price_Index     <- "https://fred.stlouisfed.org/data/PPIACO.txt"
PCE_Price_Deflator       <- PCE_Price_Index
GDP_Price_Deflator       <- GDP_Price_Index
### Download PPI ###
# PPI is Monthly #
Producer_Prices   <- as.xts(read.zoo(Producer_Price_Index, sep = "", skip = 15,   
                        index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearmon))

Inflation_Table  <- t(data.frame(Producer_Price_Index, PCE_Price_Deflator, GDP_Price_Deflator))
colnames(Inflation_Table) <- "Inflation"

kable(Inflation_Table, align = "l", caption = "Inflation data sources")

```

```{r echo = FALSE, message = FALSE, warning = FALSE, cache=TRUE}
### Income Savings ###
Personal_Income             <- "https://fred.stlouisfed.org/data/PINCOME.txt"
Gross_Private_Savings       <- "https://fred.stlouisfed.org/data/GPSAVE.txt"
Corporate_Profits_After_Tax <- "https://fred.stlouisfed.org/data/CP.txt"
Corporate_Net_Cash_Flow     <- "https://fred.stlouisfed.org/data/CNCF.txt"

### Download Income Savings Data ###
Income              <-  as.xts(read.zoo(Personal_Income, sep = "", skip = 22, index.column = 1,  
                               header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Savings             <-  as.xts(read.zoo(Gross_Private_Savings, sep = "", skip = 13, index.column = 1,  
                               header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Corporate_Profits   <-  as.xts(read.zoo(Corporate_Profits_After_Tax, sep = "", skip = 10, 
                           index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Corporate_Cash_Flow <-  as.xts(read.zoo(Corporate_Net_Cash_Flow, sep = "", skip = 13, 
                           index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))     

Income_Table <- t(data.frame(Personal_Income, Gross_Private_Savings, Corporate_Profits_After_Tax, Corporate_Net_Cash_Flow))
colnames(Income_Table) <- "Income-Savings"

kable(Income_Table, align = "l", caption = "Income & Savings data sources")
```

```{r echo = FALSE, message = FALSE, warning = FALSE, cache=TRUE}
### Liquidity-Money ###
Effective_Fed_Funds_Rate      <- "https://fred.stlouisfed.org/data/FEDFUNDS.txt"  
One_Yr_Constant_Maturity_Rate <- "https://fred.stlouisfed.org/data/GS1.txt"
Ten_Yr_Constant_Maturity_Rate <- "https://fred.stlouisfed.org/data/GS10.txt"
Corporate_debt_securities     <- "https://fred.stlouisfed.org/data/NCBDBIQ027S.txt"
All_Sectors_Liability_Level   <- "https://fred.stlouisfed.org/data/TCMDO.txt"
Adjusted_Monetary_Base        <- "https://fred.stlouisfed.org/data/AMBSL.txt"

### Download Liquidity-Money data ###
Fed_Funds      <- as.xts(read.zoo(Effective_Fed_Funds_Rate, sep = "", skip = 59, index.column = 1,  
                        header = TRUE, format = "%Y-%m-%d", FUN = as.yearmon))
Treasury_1YR   <- as.xts(read.zoo(One_Yr_Constant_Maturity_Rate, sep = "", skip = 13, index.column = 1,  
                        header = TRUE, format = "%Y-%m-%d", FUN = as.yearmon))
Treasury_10YR  <- as.xts(read.zoo(Ten_Yr_Constant_Maturity_Rate, sep = "", skip = 13, index.column = 1,                          header = TRUE, format = "%Y-%m-%d", FUN = as.yearmon))
Corporate_Debt <- as.xts(read.zoo(Corporate_debt_securities, sep = "", skip = 34, index.column = 1,  
                        header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Total_Credit_Debt <- as.xts(read.zoo(All_Sectors_Liability_Level, sep = "", skip = 19, index.column = 1,                            header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Monetary_Base <- as.xts(read.zoo(Adjusted_Monetary_Base, sep = "", skip = 18, index.column = 1,  
                        header = TRUE, format = "%Y-%m-%d", FUN = as.yearmon))
  
Liquidity_Table <- t(data.frame(Effective_Fed_Funds_Rate, One_Yr_Constant_Maturity_Rate, Ten_Yr_Constant_Maturity_Rate, Corporate_debt_securities, All_Sectors_Liability_Level, Adjusted_Monetary_Base))

colnames(Liquidity_Table) <- "Liquidity-Money"

kable(Liquidity_Table, aligns = "l", caption = "Liquidity & Money data sources")

```


```{r echo = FALSE, message = FALSE, warning = FALSE}
library(knitr)
kable(GDP_Table, align = "l", caption = "GDP Nominal, Quantity, and Price index data sources.")
```

\newpage

#Data Download and Pre-Processing

One can use `R`^[[\textcolor{blue}{`r citation()$title`}](`r citation()$url`), `r citation()$year`.
`r citation()$author`.], to download economic data directly from the source, defined by the url addresses listed previously. One of the advantages of using `R` for such a project is that it helps one avoid errors of the kind recently made famous by "Reinhart & Rogoff". ^[[\textcolor{blue}{Does high public debt consistently stifle
economic growth? A critique of Reinhart and Rogoff}](https://umassmed.edu/uploadedFiles/QHS/Camb.%20J.%20Econ.-2013-Herndon-cje-bet075.pdf). Authors: Thomas Herndon and Michael Ash. *Cambridge Journal of Economics*, Vol. 38, No. 2 (Dec., 2013), pp. 257-279] In hopes of not finding our efforts dashed by a spreadsheet error, the analysis and document preparation have been compiled by the principals of Reproducible Research. This approach helps reduce errors that occur from cutting and pasting of results or other general mismanagement inherent to working data.

Another advantage of using `R` is the library of software packages available. One such library for efficiently handling time series data is `r citation("xts")$title`.^[[\textcolor{blue}{`r citation("xts")$title`}](`r citation("xts")$url`), `r citation("xts")$year`.
`r citation("xts")$author`.    
`r citation("xts")$note`.] Among other benefits, `xts` indexes every time series by its date. This means it can be used to efficiently merge multiple components of GDP into one table based on their shared date-time index. The `merge.xts` function matches the date index of each series and ensures that observations are placed on the row corresponding to the correct date for every series. This is a necessary data preparation task not only for accuracy but also for quickly and efficiently `apply`ing variance calculations to all components simultaneously.

In the few instances when only monthly data series are available, we lower the frequency to quarterly time series. This allows for a more accurate comparison with the majority of economic time series, which are reported quarterly.

Of greater interest during the preprocessing phase of this project is converting each economic data series from nominal to Real terms. This is necessary to observe changes in variability across decades more accurately. If we don't correctly convert to Real terms, then the results will be skewed as inflation magnifies the price movements of all goods and services over time. As this is a well-understood problem, the US. Bureau of Economic Analysis makes Real series available for the major component aggregate series such as `Real Gross Domestic Product, Real Personal Consumption Expenditures`, and `Real Gross Private Domestic Investment`, dating back to 1947. However, for some of the sub-components, the Bureau's Real series are short, with history limited to 1999. Less than 20 years is hardly enough to study the variance for the post World War II period. Since we must make the transformation for some series, and minor differences could arise between the Bureau's calculation and our own, we must therefore transform each series from nominal to Real so that no measurement errors occur due to differences in methodology.

The U.S. Bureau of Economic Analysis uses the chain-type Fisher Index^[[\textcolor{blue}{Fisher's Formula for Index Numbers}](http://www.jstor.org/stable/1928524). Author: Warren M. Persons.      
*The Review of Economics and Statistics*, Vol. 3, No. 5 (May, 1921), pp. 103-113] to remove the effects of inflation. While the history of Real series produced by the Bureau is limited, fortunately, nominal prices, as well as Quantity and Price indices, are available for all components dating back to 1947. We can use these indices to compute chain-type Fisher Indices and transform nominal series into Real series for all GDP components of interest.

```{marginfigure}
**Laspeyres quantity index (L):**
Uses prices from prior period to value current and prior-period output:
$$L_{t, t-1}= \frac{\sum{P_{t-1}Q_t}}{\sum{P_{t-1}Q_{t-1}}}$$


**Paasche quantity index (P):**
Uses prices from the current period to value current and prior-period output:
$$P_{t, t-1}= \frac{\sum{P_{t}Q_t}}{\sum{P_{t}Q_{t-1}}}$$


**Fisher quantity index (F):**
Combines Laspeyres and Paasche
$$F_{t, t-1}= \sqrt{L_{t, t-1} \times P_{t, t-1}}$$ **Chain-type quantity index (I):**
Chains together Fisher indices for each pair of periods. Base $2009$ $Q1$: $$I_{t,0}=F_{t, t-1} \times \dotsc \times F_{2009Q2,2009Q1} \times \dotsc \times F_{1,0}$$

**Real Series in Chained Dollars**
$$Real_{Fisher}=\frac{Nominal}{I_{t,0}}$$


```


As anyone who has ever sifted through government websites for data can tell you, it isn't always clear if the data set discovered is what the researcher is truly looking for. This is particularly the case of more specific series, such as Price and Quantity indices we use to transform nominal prices to Real.

How do we know that we have the right indices and have used them to convert nominal to Real prices correctly? Fortunately, we can use the Bureau's limited history of Real GDP component series to test for accuracy against our Real series. These were obtained through following the formulas for Fisher chain indexing displayed to the right. By regressing the transformed nominal series (x) against that of the Bureau's (y), one can use regression diagnostics to test how well the transformation fits or match.^[**Regression Test**
$$Real_{Bureau}=\alpha+\beta Real_{Fisher} + \epsilon$$]

The results of the regression test are displayed in the table below. As one can see, very high $R^2$ values indicate that the series track extremely closely, and that our transformation is nearly identical to that of the Bureaus. In this vein, of all the data sets available I had initially selected the incorrect Quantity index for a few series of interest. Without testing for data quality, I may have used the wrong indices, which would have skewed the results. In essence, committing my very own type of "Rogoff & Reinhart" computational error.



```{r echo = FALSE, message = FALSE, warning = FALSE}
###############################################################################
### Download GDP components directly from FRED into xts time sereis object ###
##############################################################################
library(xts)
## Real components        
FPI         <- as.xts(read.zoo(Fixed_Private_Investment, sep = "", skip = 14, index.column = 1,  
                        header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
FPI_Quanity <- as.xts(read.zoo(FPI_Quantity_Index, sep = "", skip = 13, 
                        index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
FPI_Price   <- as.xts(read.zoo(FPI_Price_Index, sep = "", skip = 13, 
                        index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
#------------------------------#
PCE         <- as.xts(read.zoo(Personal_Consumption_Expenditures, sep = "", skip = 14, index.column = 1,  
                        header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
PCE_Quanity <- as.xts(read.zoo(PCE_Quantity_Index, sep = "", skip = 13, 
                        index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
PCE_Price   <- as.xts(read.zoo(PCE_Price_Index, sep = "", skip = 13, 
                        index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))

## Personal Consuption Components ##
Durable_Goods         <- as.xts(read.zoo(PCE_Durable_Goods, sep = "", skip = 14, index.column = 1,  
                                header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Durable_Goods_Quanity <- as.xts(read.zoo(Durable_Goods_Quanity_Index, sep = "", skip = 13, 
                                index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Durable_Goods_Price   <- as.xts(read.zoo(Durable_Goods_Price_Index, sep = "", skip = 13, 
                                index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
#------------------------------#        
Nondurable_Goods          <- as.xts(read.zoo(PCE_Nondurable_Goods, sep = "", skip = 14, index.column = 1,  
                                header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Nondurable_Goods_Quantity <- as.xts(read.zoo(Nondurable_Goods_Quantity_Index, sep = "", skip = 13, 
                                index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Nondurable_Goods_Price    <- as.xts(read.zoo(Nondurable_Goods_Price_Index, sep = "", skip = 13, 
                                index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
#------------------------------#         
Services          <- as.xts(read.zoo(PCE_Services, sep = "", skip = 14, index.column = 1,  
                          header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Services_Quantity <- as.xts(read.zoo(Services_Quantity_Index, sep = "", skip = 13, 
                          index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr)) 
Services_Price    <- as.xts(read.zoo(Services_Price_Index, sep = "", skip = 13, 
                          index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
        
## Fixed Private Investment Components ##
Residential          <- as.xts(read.zoo(Residential_Fixed_Investment, sep = "", skip = 11, 
                        index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Residential_Quantity <- as.xts(read.zoo(Residential_Quantity_Index, sep = "", skip = 13, 
                        index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr)) 
Residential_Price    <- as.xts(read.zoo(Residential_Price_Index, sep = "", skip = 13, 
                        index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
#------------------------------#       
Nonresidential          <- as.xts(read.zoo(Nonresidential_Fixed_Investment, sep = "", skip = 11, 
                                  index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Nonresidential_Quantity <- as.xts(read.zoo(Nonresidential_Quantity_Index, sep = "", skip = 13, 
                                  index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))  
Nonresidential_Price    <- as.xts(read.zoo(Nonresidential_Price_Index, sep = "", skip = 13, 
                                 index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))

## Exports and Imports. Don't forget to construct NET by subtracting from each other ##
Exports          <- as.xts(read.zoo(Exports_Goods_Services, sep = "", skip = 13, 
                        index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Exports_Quantity <- as.xts(read.zoo(Exports_Quantity_Index, sep = "", skip = 13, 
                        index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Exports_Price    <- as.xts(read.zoo(Exports_Price_Index , sep = "", skip = 13, 
                        index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
#-------------------------------------#
Imports          <- as.xts(read.zoo(Imports_Goods_Services, sep = "", skip = 13, 
                           index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Imports_Quantity <- as.xts(read.zoo(Imports_Quantity_Index, sep = "", skip = 13, 
                           index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Imports_Price    <- as.xts(read.zoo(Imports_Price_Index , sep = "", skip = 13, 
                           index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))

## Government Consumption Expenditures Federal and Local ###
Federal          <- as.xts(read.zoo(Federal_GCE, sep = "", skip = 13, 
                           index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Federal_Quantity <- as.xts(read.zoo(Federal_Quantity_Index, sep = "", skip = 13, 
                           index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Federal_Price    <- as.xts(read.zoo(Federal_Price_Index  , sep = "", skip = 13, 
                           index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
#------------------------------# 
State_Local          <- as.xts(read.zoo(State_Local_GCE, sep = "", skip = 13, 
                              index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
State_Local_Quantity <- as.xts(read.zoo(State_Local_Quantity_Index, sep = "", skip = 13, 
                              index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
State_Local_Price    <- as.xts(read.zoo(State_Local_Price_Index  , sep = "", skip = 13, 
                              index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))

##################################################
### Transform nominal series to Real using the ###
### Fisher function we defined earlier.       ###
### Assemble Net exports and total government  ###
##################################################

Real_PCE <- Fisher(PCE, PCE_Price, PCE_Quanity, 249)
Real_FPI <- Fisher(FPI, FPI_Price, FPI_Quanity, 249)
##----------------------------------##
Real_Durable_Goods    <- Fisher(Durable_Goods, Durable_Goods_Price, Durable_Goods_Quanity, 249)
Real_Nondurable_Goods <- Fisher(Nondurable_Goods, Nondurable_Goods_Price, Nondurable_Goods_Quantity, 249)
Real_Services         <- Fisher(Services, Services_Price, Services_Quantity, 249)
##----------------------------------##
Real_Residential      <- Fisher(Residential, Residential_Price, Residential_Quantity, 249)
Real_Nonresidential   <- Fisher(Nonresidential, Nonresidential_Price, Nonresidential_Quantity, 249)
##----------------------------------##
Real_Exports          <- Fisher(Exports, Exports_Price, Exports_Quantity, 249)
Real_Imports          <- Fisher(Imports, Imports_Price, Imports_Quantity, 249)
Net_Imports_Exports   <- Exports - Imports
##----------------------------------##
Real_Federal          <- Fisher(Federal, Federal_Price, Federal_Quantity, 249)
Real_State_Local      <- Fisher(State_Local, State_Local_Price, State_Local_Quantity, 249)
Total_Government      <- Real_Federal + Real_State_Local
## Assemble all Real variables into an xts  matrix.
Real_xts <- merge(Real_GDP, Real_FPI, Real_PCE, Real_Durable_Goods, Real_Nondurable_Goods, 
                 Real_Services, Real_Residential, Real_Nonresidential,
                 Real_Exports, Real_Imports, Real_Federal, Real_State_Local)

#####################################################################
# Now, lets Regression test every series, to make sure its correct. #
#####################################################################

rPCE <- as.xts(read.zoo("https://fred.stlouisfed.org/data/PCECC96.txt", skip = 13, index.column = 1,  
                header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
rDurable <- as.xts(read.zoo("https://fred.stlouisfed.org/data/PCDGCC96.txt", skip = 13, index.column = 1,  
                                       header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
rNondurable <- as.xts(read.zoo("https://fred.stlouisfed.org/data/PCNDGC96.txt", skip = 13, index.column = 1,  
                                       header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
rServices <- as.xts(read.zoo("https://fred.stlouisfed.org/data/PCESVC96.txt", skip = 13, index.column = 1,  
                                   header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
rFPI <- as.xts(read.zoo("https://fred.stlouisfed.org/data/PRFIC96.txt", skip = 13, index.column = 1,  
                        header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
rNonresidential <- as.xts(read.zoo("https://fred.stlouisfed.org/data/PNFIC96.txt", skip = 13, index.column = 1,  
                        header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
rResidential <- as.xts(read.zoo("https://fred.stlouisfed.org/data/PRFIC96.txt", skip = 13, index.column = 1,  
                                   header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
rExports  <- as.xts(read.zoo("https://fred.stlouisfed.org/data/EXPGSC1.txt", skip = 13, index.column = 1,  
                                            header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
rImports <-  as.xts(read.zoo("https://fred.stlouisfed.org/data/IMPGSC1.txt", skip = 13, index.column = 1,  
                                            header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))

rFederal <-  as.xts(read.zoo("https://fred.stlouisfed.org/data/FGCEC96.txt", skip = 13, index.column = 1,  
                                            header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))

rState_Local <-  as.xts(read.zoo("https://fred.stlouisfed.org/data/SLCEC96.txt", skip = 13, index.column = 1,  
                                            header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))

# Create real data xts object from FRED downloads
r_xts <- merge(rGDP, rPCE, rDurable, rNondurable, 
                  rServices, rFPI, rResidential, rNonresidential,
                  rExports, rImports, rFederal, rState_Local)

# merge with what I created
test_xts <- merge(Real_xts, r_xts)
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
# Run Regression tests for rsquared
GDP_regression <- summary(lm(rGDP ~ Real_GDP, test_xts))

        PCE_regression <- summary(lm(rPCE ~ Real_PCE, test_xts))
   Durables_regression <- summary(lm(rDurable ~ Real_Durable_Goods, test_xts))
Nondurables_regression <- summary(lm(rNondurable ~ Real_Nondurable_Goods, test_xts))
   Services_regression <- summary(lm(rServices ~ Real_Services, test_xts))

           FPI_regression <- summary(lm(rFPI ~ Real_FPI, test_xts))
   Residential_regression <- summary(lm(rResidential ~ Real_Residential, test_xts))
Nonresidential_regression <- summary(lm(rNonresidential ~ Real_Nonresidential, test_xts))

    Exports_regression <- summary(lm(rExports ~ Real_Exports, test_xts))
    Imports_regression <- summary(lm(rImports ~ Real_Imports, test_xts))
    Federal_regression <- summary(lm(rFederal ~ Real_Federal, test_xts))
State_Local_regression <- summary(lm(rState_Local ~ Real_State_Local, test_xts))

Regression_table <- t(data.frame(GDP_regression$coefficients[2,], 
                           PCE_regression$coefficients[2,], 
                           Durables_regression$coefficients[2,], 
                           Nondurables_regression$coefficients[2,],
                           Services_regression$coefficients[2,], 
                           FPI_regression$coefficients[2,], 
                           Residential_regression$coefficients[2,], 
                           Nonresidential_regression$coefficients[2,], 
                           Exports_regression$coefficients[2,], 
                           Imports_regression$coefficients[2,],
                           Federal_regression$coefficients[2,], 
                           State_Local_regression$coefficients[2,]))

Rsquared_table  <- t(data.frame(GDP_regression$r.squared, 
                                PCE_regression$r.squared, 
                                Durables_regression$r.squared, 
                                Nondurables_regression$r.squared,
                                Services_regression$r.squared, 
                                FPI_regression$r.squared, 
                                Residential_regression$r.squared, 
                                Nonresidential_regression$r.squared, 
                                Exports_regression$r.squared, 
                                Imports_regression$r.squared,
                                Federal_regression$r.squared, 
                                State_Local_regression$r.squared))

colnames(Rsquared_table) <- "$R^2$"

# make the table
Test_table <- cbind(Rsquared_table, Regression_table)

rownames(Test_table) <- gsub("\\..*","",rownames(Test_table))

# order the table and make it data.frame.
names <-  colnames(Test_table)

Test_table <- data.frame(Test_table[order(Test_table[,1], decreasing = TRUE),])

colnames(Test_table) <- names
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
kable(Test_table)
```


```{r echo = FALSE, message = FALSE, warning = FALSE, fig.width = 5, fig.height = 6, fig.fullwidth = TRUE, fig.cap = "Plot of GDP Components"}

library(ggplot2)
library(ggthemes)
library(ggfortify)

#autoplot(Real_xts, ncol=2, stacked = TRUE) +
 #        scale_x_continuous(position = "top") +
  #       scale_y_continuous(position = "right") +
   #      theme_bw()

```



\newpage



A graph of the percentage change of Real GDP. A break in 1982 begins the period known as "The Great Moderation", when variance among traditional economic data begins to shrink. 
```{r echo = FALSE, message = FALSE, warning = FALSE, fig.width = 5, fig.height = 4}

library(xts)
great_df <- data.frame(date=index(Real_GDP[-1]), Real_GDP = 100*diff(log(coredata(Real_GDP))))

pre_1982 <- data.frame(y = rep(mean(great_df[great_df$date < 1982,]$Real_GDP), 139), x = great_df[great_df$date < 1982,]$date)

post_1982 <- data.frame(y = rep(mean(great_df[great_df$date > 1981,]$Real_GDP), sum(great_df$date >= 1982, na.rm=TRUE)), x = great_df[great_df$date >= 1982,]$date)

plot_title <- "Real GDP Growth"
x_axis <- "Years: 1947 - Present"
y_axis <- "Real GDP, % change"

plot(y = great_df$Real_GDP, x= great_df$date, col="darkgrey", type ="l", main = plot_title, xlab = x_axis, ylab = y_axis)
abline(v = 1982.00, lty = 2, lwd =2, col = "darkgreen")

```

Below, blue and green lines represent average GDP for their time periods. A cyclic penalized cubic regression spline smoother is superimposed in red. With a lambda $\lambda$ parameter set to 16, or roughly 16 quarters, it visually captures the signal in the noise of quarterly GDP. The trend continues to remain below long term averages.

```{r, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 5, fig.height = 4}
library(mgcv)
#gdp_loess <- loess(Real_GDP ~ date, data = great_df, span = 0.16)

gdp_gam <- mgcv::gam(Real_GDP ~ s(index(date), bs="cc", k=16, fx=TRUE), data = great_df, method = "REML")
#gdp_ar <- ar(great_df$Real_GDP, order.max=1)
#gdp_gam

plot_title <- "Real GDP, a signal in the noise"
x_axis <- "Years: 1947 - Present"
y_axis <- "Real GDP, % change"

plot(y = great_df$Real_GDP, x= great_df$date, col="darkgrey", type = "l", main = plot_title, xlab = x_axis, ylab = y_axis)
lines(y=pre_1982$y, x=pre_1982$x, col="blue", lwd=2)
lines(y=post_1982$y, x=post_1982$x, col="darkgreen", lwd=2)
lines(y=gdp_gam$fitted.values , x = great_df$date, col="red", lwd=2)
#lines(y=(great_df$Real_GDP-gdp_blanch$resid), x = great_df$date, col="black", lwd=2)
abline(v = 1982, lty = 2, col = "darkgreen")
abline(h = 0, lty = 2, col = "darkgreen")
```


\newpage


```{r echo = FALSE, message = FALSE, warning = FALSE, fig.width = 5, fig.height = 6, fig.fullwidth = TRUE, fig.cap = "Plot of GDP Components, 1947-Present"}
autoplot(Real_xts, ncol=2, stacked = TRUE) +
        scale_y_continuous(position = "right") +
        theme_bw()

```

```{r echo = FALSE, message = FALSE, warning = FALSE, fig.width = 5, fig.height = 6, fig.fullwidth = TRUE, fig.cap = "Autocorrelation plot of GDP Components"}
# Log transform every series and multiply by 100 for interpretability
Real_DF_log <- 100*diff(Real_xts, lag = 1, differences = 1, log = TRUE)

Real_DF_log <- Real_DF_log[-1,]

######################################
## Diagnostics and data exploration ##
######################################

# Chart auto-correlation plots of change in data frame rates
## setup framework for 4 x 3 charts ##

library(forecast)
library(tidyr)
library(ggplot2)
library(ggthemes)

# create autocorrelation function to `apply` over xts
Acf_acf <- function(x) {
        
        Acf(x, plot = FALSE)[["acf"]]
        
}

gdp_autocorr <- data.frame("lag"=Acf(Real_DF_log$Real_GDP, plot = FALSE)[["lag"]], 
                      apply(Real_DF_log, 2, Acf_acf))

autocorr_table <- gather(gdp_autocorr[-1, ], "series", "acf", 2:13)

autocorr_graph <- ggplot(autocorr_table, aes(x = lag, y = acf)) +
                        geom_errorbar(aes(x = lag, 
                                          ymax = acf, 
                                          ymin = 0), 
                                          width = 0) +
                        facet_wrap(~series, ncol = 2) +
                        scale_x_continuous(breaks = seq(0, 24, 4), 
                                           limits = c(0, 24),
                                           position = "top") +
                        scale_y_continuous(position = "right") +
                        theme_bw()

autocorr_graph
#ggdraw(autocorr_graph + theme_tufte())
```
```{r echo = FALSE, message = FALSE, warning = FALSE, fig.width = 5, fig.height = 6, fig.fullwidth = TRUE, fig.cap = "GDP Components as a Percent of GDP"}
percent_GDP <- xts(do.call(merge, lapply(Real_xts, function(x) 100*(x/Real_xts$Real_GDP))), order.by = index(Real_xts))

perc_GDP_2008 <- percent_GDP["2007/"]

autoplot(perc_GDP_2008, ncol=2, stacked = TRUE) +
        scale_y_continuous(position = "right") +
        theme_bw()
```
